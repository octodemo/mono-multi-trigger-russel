name: Manual Deployment with Approvals

on:
  workflow_dispatch:
    inputs:
      service-a:
        description: 'Deploy service-a'
        required: false
        default: false
        type: boolean
      service-b:
        description: 'Deploy service-b'
        required: false
        default: false
        type: boolean
      service-c:
        description: 'Deploy service-c'
        required: false
        default: false
        type: boolean
      service-d:
        description: 'Deploy service-d'
        required: false
        default: false
        type: boolean
      service-e:
        description: 'Deploy service-e'
        required: false
        default: false
        type: boolean
      version:
        description: 'Version/tag to deploy (default: latest)'
        required: false
        default: 'latest'
        type: string
      dry_run:
        description: 'Perform a dry run (no actual deployment)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20.x'

jobs:
  validate-inputs:
    runs-on: ubuntu-latest
    outputs:
      services-matrix: ${{ steps.parse.outputs.services-matrix }}
      valid-services: ${{ steps.parse.outputs.valid-services }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Parse and validate services
      id: parse
      run: |
        # Define valid services and collect selected services
        VALID_SERVICES=("service-a" "service-b" "service-c" "service-d" "service-e")
        SELECTED_SERVICES=()
        
        # Check which services were selected via checkbox
        if [[ "${{ github.event.inputs.service-a }}" == "true" ]]; then
          SELECTED_SERVICES+=("service-a")
        fi
        if [[ "${{ github.event.inputs.service-b }}" == "true" ]]; then
          SELECTED_SERVICES+=("service-b")
        fi
        if [[ "${{ github.event.inputs.service-c }}" == "true" ]]; then
          SELECTED_SERVICES+=("service-c")
        fi
        if [[ "${{ github.event.inputs.service-d }}" == "true" ]]; then
          SELECTED_SERVICES+=("service-d")
        fi
        if [[ "${{ github.event.inputs.service-e }}" == "true" ]]; then
          SELECTED_SERVICES+=("service-e")
        fi
        
        # Check if any services were selected
        if [ ${#SELECTED_SERVICES[@]} -eq 0 ]; then
          echo "âŒ No services selected for deployment"
          exit 1
        fi
        
        # Create comma-separated list of services for display
        VALID_SELECTED=$(IFS=,; echo "${SELECTED_SERVICES[*]}")
        
        # Create matrix for parallel deployment
        MATRIX_JSON=$(printf '%s\n' "${SELECTED_SERVICES[@]}" | jq -R . | jq -s -c .)
        
        echo "services-matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
        echo "valid-services=$VALID_SELECTED" >> $GITHUB_OUTPUT
        
        echo "âœ… Selected services to deploy: $VALID_SELECTED"
        echo "ðŸ·ï¸ Version: ${{ github.event.inputs.version }}"
        echo "ðŸ§ª Dry run: ${{ github.event.inputs.dry_run }}"

  run-tests:
    runs-on: ubuntu-latest
    needs: validate-inputs
    if: ${{ !cancelled() }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Use Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run all tests
      run: npm test
      
    - name: Create test summary
      if: always()
      run: |
        echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… Tests passed successfully. Services are ready for deployment approval." >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Tests failed. Please check the logs for more details." >> $GITHUB_STEP_SUMMARY
        fi

  # New job for manual approval with environment selection for each service
  approval:
    runs-on: ubuntu-latest
    needs: [validate-inputs, run-tests]
    if: ${{ !cancelled() && needs.run-tests.result == 'success' }}
    strategy:
      matrix:
        service: ${{ fromJson(needs.validate-inputs.outputs.services-matrix) }}
      fail-fast: false
    
    # This creates a manual approval step for each service
    environment: approval-${{ matrix.service }}
    
    outputs:
      approved-services: ${{ steps.collect-approvals.outputs.approved-services }}
      service-environments: ${{ steps.collect-approvals.outputs.service-environments }}
    
    steps:
    - name: Await deployment approval for ${{ matrix.service }}
      run: |
        echo "âœ… Deployment for ${{ matrix.service }} has been approved."
        echo "ðŸ“ Selected environment: ${{ vars.TARGET_ENVIRONMENT || 'Not specified' }}"
    
    - name: Collect approval information
      id: collect-approvals
      run: |
        # In a real scenario, you'd store the selected environment for each service
        # Here we're using the environment variable set at environment level
        echo "approved-service=${{ matrix.service }}" >> $GITHUB_OUTPUT
        echo "service-environment=${{ vars.TARGET_ENVIRONMENT || 'dev' }}" >> $GITHUB_OUTPUT

  deploy:
    runs-on: ubuntu-latest
    needs: [validate-inputs, approval]
    if: ${{ !cancelled() }}
    strategy:
      matrix:
        service: ${{ fromJson(needs.validate-inputs.outputs.services-matrix) }}
      fail-fast: false
    
    # Use the environment that was chosen during the approval step
    # This would be configured differently based on how you capture the selection
    environment: ${{ needs.approval.outputs[format('service-environments-{0}', matrix.service)] || 'dev' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up deployment environment
      run: |
        echo "ðŸš€ Preparing to deploy ${{ matrix.service }} to ${{ env.ENVIRONMENT }}"
        echo "SERVICE=${{ matrix.service }}" >> $GITHUB_ENV
        echo "ENVIRONMENT=${{ env.ENVIRONMENT }}" >> $GITHUB_ENV
        echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV
        echo "DRY_RUN=${{ github.event.inputs.dry_run }}" >> $GITHUB_ENV
        
    - name: Use Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Test specific service
      run: npm run test:${{ matrix.service }}
      
    - name: Build service (if needed)
      run: |
        echo "ðŸ“¦ Building ${{ matrix.service }}..."
        cd services/${{ matrix.service }}
        # In a real scenario, you might run build commands here
        # npm run build
        echo "âœ… Build completed for ${{ matrix.service }}"
        
    - name: Deploy to ${{ env.ENVIRONMENT }}
      run: |
        echo "ðŸš€ Deploying ${{ matrix.service }} to ${{ env.ENVIRONMENT }}..."
        
        if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
          echo "ðŸ§ª DRY RUN: Would deploy ${{ matrix.service }} to ${{ env.ENVIRONMENT }}"
          echo "ðŸ§ª DRY RUN: Version: ${{ github.event.inputs.version }}"
          echo "ðŸ§ª DRY RUN: No actual deployment performed"
        else
          echo "ðŸ“ Environment: ${{ env.ENVIRONMENT }}"
          echo "ðŸ·ï¸ Version: ${{ github.event.inputs.version }}"
          echo "ðŸ“¦ Service: ${{ matrix.service }}"
          
          # Simulate deployment steps
          echo "  â³ Stopping existing service..."
          sleep 2
          echo "  ðŸ“¤ Uploading new version..."
          sleep 3
          echo "  â–¶ï¸ Starting service..."
          sleep 2
          echo "  ðŸ” Health check..."
          sleep 1
          echo "  âœ… Deployment successful!"
          
          # In a real scenario, you would:
          # - Build and push Docker images
          # - Update Kubernetes deployments
          # - Update configuration
          # - Perform health checks
          # - Rollback if needed
        fi
        
    - name: Post-deployment verification
      if: ${{ github.event.inputs.dry_run != 'true' }}
      run: |
        echo "ðŸ” Verifying deployment of ${{ matrix.service }}..."
        
        # Simulate health check
        echo "  ðŸ“Š Checking service health..."
        sleep 2
        echo "  âœ… Service is healthy"
        
        echo "  ðŸ“ˆ Checking metrics..."
        sleep 1
        echo "  âœ… Metrics look good"
        
        echo "ðŸŽ‰ Deployment verification complete for ${{ matrix.service }}"

  deployment-summary:
    runs-on: ubuntu-latest
    needs: [validate-inputs, run-tests, approval, deploy]
    if: ${{ !cancelled() }}
    steps:
    - name: Deployment Summary
      run: |
        echo "## ðŸ“‹ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Dry Run:** ${{ github.event.inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
        echo "**Services:** ${{ needs.validate-inputs.outputs.valid-services }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.run-tests.result }}" = "success" ]; then
          echo "âœ… **Tests:** Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Tests:** Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.approval.result }}" = "success" ]; then
          echo "âœ… **Approval:** Granted" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Approval:** Denied or Skipped" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.deploy.result }}" = "success" ]; then
          echo "âœ… **Deployment:** Successful" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.deploy.result }}" = "failure" ]; then
          echo "âŒ **Deployment:** Failed" >> $GITHUB_STEP_SUMMARY
        else
          echo "â­ï¸ **Deployment:** Skipped" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— **Workflow run:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
