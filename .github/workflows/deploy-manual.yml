name: Manual Deployment

on:
  workflow_dispatch:
    inputs:
      services:
        description: 'Services to deploy (comma-separated)'
        required: true
        default: 'service-a,service-b,service-c,service-d,service-e'
        type: string
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - test1
        - test2
        - prod
      version:
        description: 'Version/tag to deploy (default: latest)'
        required: false
        default: 'latest'
        type: string
      dry_run:
        description: 'Perform a dry run (no actual deployment)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20.x'

jobs:
  validate-inputs:
    runs-on: ubuntu-latest
    outputs:
      services-matrix: ${{ steps.parse.outputs.services-matrix }}
      valid-services: ${{ steps.parse.outputs.valid-services }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Parse and validate services
      id: parse
      run: |
        # Define valid services
        VALID_SERVICES="service-a service-b service-c service-d service-e"
        
        # Parse input services
        IFS=',' read -ra SERVICES <<< "${{ github.event.inputs.services }}"
        
        # Trim whitespace and validate
        VALID_SELECTED=""
        INVALID_SERVICES=""
        
        for service in "${SERVICES[@]}"; do
          service=$(echo "$service" | xargs | sed 's/^"//;s/"$//')  # trim whitespace and remove quotes
          if [[ " $VALID_SERVICES " =~ " $service " ]]; then
            if [ -z "$VALID_SELECTED" ]; then
              VALID_SELECTED="$service"
            else
              VALID_SELECTED="$VALID_SELECTED,$service"
            fi
          else
            if [ -z "$INVALID_SERVICES" ]; then
              INVALID_SERVICES="$service"
            else
              INVALID_SERVICES="$INVALID_SERVICES,$service"
            fi
          fi
        done
        
        if [ -n "$INVALID_SERVICES" ]; then
          echo "âŒ Invalid services specified: $INVALID_SERVICES"
          echo "Valid services are: $VALID_SERVICES"
          exit 1
        fi
        
        # Create matrix for parallel deployment
        MATRIX_JSON=$(echo "$VALID_SELECTED" | tr ',' '\n' | jq -R . | jq -s -c .)
        
        echo "services-matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
        echo "valid-services=$VALID_SELECTED" >> $GITHUB_OUTPUT
        
        echo "âœ… Valid services to deploy: $VALID_SELECTED"
        echo "ðŸ“ Target environment: ${{ github.event.inputs.environment }}"
        echo "ðŸ·ï¸ Version: ${{ github.event.inputs.version }}"
        echo "ðŸ§ª Dry run: ${{ github.event.inputs.dry_run }}"

  run-tests:
    runs-on: ubuntu-latest
    needs: validate-inputs
    if: ${{ !cancelled() }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Use Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run all tests
      run: npm test

  deploy:
    runs-on: ubuntu-latest
    needs: [validate-inputs, run-tests]
    if: ${{ !cancelled() && needs.run-tests.result == 'success' }}
    strategy:
      matrix:
        service: ${{ fromJson(needs.validate-inputs.outputs.services-matrix) }}
      fail-fast: false
    environment: ${{ github.event.inputs.environment }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up deployment environment
      run: |
        echo "ðŸš€ Preparing to deploy ${{ matrix.service }} to ${{ github.event.inputs.environment }}"
        echo "SERVICE=${{ matrix.service }}" >> $GITHUB_ENV
        echo "ENVIRONMENT=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
        echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV
        echo "DRY_RUN=${{ github.event.inputs.dry_run }}" >> $GITHUB_ENV
        
    - name: Use Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Test specific service
      run: npm run test:${{ matrix.service }}
      
    - name: Build service (if needed)
      run: |
        echo "ðŸ“¦ Building ${{ matrix.service }}..."
        cd services/${{ matrix.service }}
        # In a real scenario, you might run build commands here
        # npm run build
        echo "âœ… Build completed for ${{ matrix.service }}"
        
    - name: Deploy to ${{ github.event.inputs.environment }}
      run: |
        echo "ðŸš€ Deploying ${{ matrix.service }} to ${{ github.event.inputs.environment }}..."
        
        if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
          echo "ðŸ§ª DRY RUN: Would deploy ${{ matrix.service }} to ${{ github.event.inputs.environment }}"
          echo "ðŸ§ª DRY RUN: Version: ${{ github.event.inputs.version }}"
          echo "ðŸ§ª DRY RUN: No actual deployment performed"
        else
          echo "ðŸ“ Environment: ${{ github.event.inputs.environment }}"
          echo "ðŸ·ï¸ Version: ${{ github.event.inputs.version }}"
          echo "ðŸ“¦ Service: ${{ matrix.service }}"
          
          # Simulate deployment steps
          echo "  â³ Stopping existing service..."
          sleep 2
          echo "  ðŸ“¤ Uploading new version..."
          sleep 3
          echo "  â–¶ï¸ Starting service..."
          sleep 2
          echo "  ðŸ” Health check..."
          sleep 1
          echo "  âœ… Deployment successful!"
          
          # In a real scenario, you would:
          # - Build and push Docker images
          # - Update Kubernetes deployments
          # - Update configuration
          # - Perform health checks
          # - Rollback if needed
        fi
        
    - name: Post-deployment verification
      if: ${{ github.event.inputs.dry_run != 'true' }}
      run: |
        echo "ðŸ” Verifying deployment of ${{ matrix.service }}..."
        
        # Simulate health check
        echo "  ðŸ“Š Checking service health..."
        sleep 2
        echo "  âœ… Service is healthy"
        
        echo "  ðŸ“ˆ Checking metrics..."
        sleep 1
        echo "  âœ… Metrics look good"
        
        echo "ðŸŽ‰ Deployment verification complete for ${{ matrix.service }}"

  deployment-summary:
    runs-on: ubuntu-latest
    needs: [validate-inputs, run-tests, deploy]
    if: ${{ !cancelled() }}
    steps:
    - name: Deployment Summary
      run: |
        echo "## ðŸ“‹ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Dry Run:** ${{ github.event.inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
        echo "**Services:** ${{ needs.validate-inputs.outputs.valid-services }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.run-tests.result }}" = "success" ]; then
          echo "âœ… **Tests:** Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Tests:** Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.deploy.result }}" = "success" ]; then
          echo "âœ… **Deployment:** Successful" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.deploy.result }}" = "failure" ]; then
          echo "âŒ **Deployment:** Failed" >> $GITHUB_STEP_SUMMARY
        else
          echo "â­ï¸ **Deployment:** Skipped" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— **Workflow run:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY